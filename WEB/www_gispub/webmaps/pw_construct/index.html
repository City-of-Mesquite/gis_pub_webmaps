<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>City of Mesquite Public Works Construction Projects| Basic Search</title>
    <link rel="stylesheet" href="http://gispub.cityofmesquite.com:81/arcgis_js_api/library/3.13/3.13/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://gispub.cityofmesquite.com:81/arcgis_js_api/library/3.13/3.13/esri/css/esri.css">
    <style type="text/css">
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #search {
            display: block;
            position: absolute;
            z-index: 2;
            top: 20px;
            left: 74px;
        }
    </style>
    <script type="text/javascript"  src="http://gispub.cityofmesquite.com:81/arcgis_js_api/library/3.13/3.13compact/init.js"></script>
    <script type="text/javascript">
        require([
            "dojo/dom-construct"
            ,"esri/geometry/Extent"
            ,"esri/map"
            ,"esri/InfoWindowBase"
            ,"esri/InfoTemplate"
            ,"esri/layers/FeatureLayer"
            ,"esri/dijit/Search"
            ,"esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol"
            ,"esri/renderers/SimpleRenderer", "esri/graphic", "esri/lang"
            ,"esri/Color", "dojo/number", "dojo/dom-style"
            ,"dijit/TooltipDialog", "dijit/popup"
            ,"dojo/domReady!"
        ], function (
                domConstruct
                ,Extent
                ,Map
                ,InfoWindowBase
                ,InfoTemplate
                ,FeatureLayer
                ,Search
                ,SimpleFillSymbol, SimpleLineSymbol
                ,SimpleRenderer, Graphic, esriLang
                ,Color, number, domStyle
                ,TooltipDialog, dijitPopup
                ) {
            var urls = {
                "urlBm": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/cached_services/basemap_parcels_bldg_add/MapServer"
                ,"urlMs": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/public_works/PW_City_Construction_Projects/MapServer"
                ,"urlFs": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/public_works/PW_City_Construction_Projects/FeatureServer/0"
            };

            var bounds = new Extent({
                xmin: 2526488.307204361,
                ymin: 6968421.825135857,
                xmax: 2574514.620465,
                ymax: 6996793.93402322 ,
                "spatialReference": {"wkid":102738}
            });

            var map = new esri.Map("mapDiv", {
                scale:  144447.638572,
                extent: bounds
            });
            var baseMap = new esri.layers.ArcGISTiledMapServiceLayer(urls.urlBm);
            var layer = new esri.layers.ArcGISDynamicMapServiceLayer(urls.urlMs);
            map.addLayer(baseMap);
            map.addLayer(layer);



            var s = new Search({map: map}, "searchDiv");
            s.startup();
            function mapInit() {
                var infoWindow = new InfoWindowBase(null, domConstruct.create("div", null, null, map.root));
                infoWindow.startup();
                map.setInfoWindow(infoWindow);

                var template = new InfoTemplate();
                template.setTitle("<b>${PROJECT_TYPE} - ${PROJECT_NAME}</b>");
                template.setContent("*");


                var resizeTimer ;

                var featureLayerOptions = {
                    id: "Projects"
                    , mode: FeatureLayer.MODE_AUTO
                    , outFields: ["*"]
                    , infoTemplate: template
                };



                var flPwProjects = new FeatureLayer(urls.urlFs,featureLayerOptions);


                map.addLayer(flPwProjects);

                map.infoWindow.resize(200, 75);

            }   // mapInit
            function mapInit2(){

                var featureLayerOptions = {
                    id: "Projects"
                    , mode: FeatureLayer.MODE_AUTO
                    , outFields: ["*"]
                    , infoTemplate: template
                };



                var flPwProjects = new FeatureLayer(urls.urlFs,featureLayerOptions);

               // flPwProjects.setDefinitionExpression("OBJECTID > 0");

                var symbol = new SimpleLineSymbol(
                        SimpleLineSymbol.STYLE_SOLID,
                        new Color([255,255,255,0.35]),
                        1
                );
                flPwProjects.setRenderer(new SimpleRenderer(symbol));
                map.addLayer(flPwProjects);

                map.infoWindow.resize(245,125);

                dialog = new TooltipDialog({
                    id: "tooltipDialog",
                    style: "position: absolute; width: 250px; font: normal normal normal 10pt Helvetica;z-index:100"
                });
                dialog.startup();

                var highlightSymbol = new SimpleLineSymbol(
                        SimpleLineSymbol.STYLE_SOLID,
                        new Color([255,0,0]), 3
                );
                //close the dialog when the mouse leaves the highlight graphic
                map.on("load", function(){
                    map.graphics.enableMouseEvents();
                    map.graphics.on("mouse-out", closeDialog);

                });

                var test_var = new InfoWindowBase("test",{});


                flPwProjects.on("click", function(evt){
                    var t = "<b>${PROJECT_TYPE}</b><hr><b>PROJECT_NAME: </b>${PROJECT_NAME}<br>"
                            + "<b>${PROJECT_SCOPE}</b><hr><b>PROJECT_SCOPE: </b>${PROJECT_SCOPE}<br>"
                            + "<b>${PROJECT_STATUS}</b><hr><b>PROJECT_STATUS: </b>${PROJECT_STATUS}<br>"
                            + "<b>${PROJECT_SCHEDULE}</b><hr><b>PROJECT_SCHEDULE: </b>${PROJECT_SCHEDULE}<br>"
                            + "<b>${HYPERLINK}</b><hr><b>HYPERLINK: </b>${HYPERLINK}<br>";

                    var content = esriLang.substitute(evt.graphic.attributes,t);
                    var highlightGraphic = new Graphic(evt.graphic.geometry,highlightSymbol);
                    map.graphics.add(highlightGraphic);

                    dialog.setContent(content);

                    domStyle.set(dialog.domNode, "opacity", 0.85);
                    dijitPopup.open({
                        popup: dialog,
                        x: evt.pageX,
                        y: evt.pageY
                    });
                });

                function closeDialog() {
                    map.graphics.clear();
                    dijitPopup.close(dialog);
                }   // close dialog
            }   // mapinit2
            map.on ("load",mapInit2);
        }); // end req-func
    </script>
</head>

<body>
 <div id="searchDiv"></div>
 <div id="mapDiv"></div>
</body>

</html>
