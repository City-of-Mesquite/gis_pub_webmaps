<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Popup - Sidebar</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/claro/claro.css" />
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open Sans">

    <style>
        html, body {
            height:100%;
            width:100%;
            margin:0;
            padding:0;
            margin:0;
            font-family: "Open Sans";
        }
        #leftPane {
            width:20%;
            margin:0;
            border:none;
        }
        #map {
            padding:0;
        }
        .nav {
            padding: 5px 10px;
            background: #4479BA;
            color: #FFF;
            border-radius: 5px;
            border: solid 1px #20538D;
            text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.4);
            -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 1px 1px rgba(0, 0, 0, 0.2);
            -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 1px 1px rgba(0, 0, 0, 0.2);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 1px 1px rgba(0, 0, 0, 0.2);

        }
        #header {
            text-align: center;
            height:60px;
            border-bottom: solid 1px #ccc;
        }
    </style>

    <script type="text/javascript"  src="http://gispub.cityofmesquite.com:81/arcgis_js_api/library/3.13/3.13/init.js"></script>
    <script type="text/javascript">
        require([
            "dojo/ready",
            "dojo/on",
            "dojo/_base/connect",
            "dojo/dom",
            "dijit/registry",
            "dojo/dom-construct",
            "dojo/parser",
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane",
            "esri/map",
            "esri/geometry/Extent",
            "esri/layers/FeatureLayer",
            "esri/InfoTemplate",
            "esri/arcgis/utils",
            "esri/domUtils",
            "esri/dijit/Popup"
        ], function(
                ready,
                on,
                connect,
                dom,
                registry,
                domConstruct,
                parser,
                BorderContainer,
                ContentPane,
                Map,
                Extent,
                FeatureLayer,
                InfoTemplate,
                arcgisUtils,
                domUtils,
                Popup
        ) {
            ready(function(){

                parser.parse();

                //setup event handlers for the next/previous buttons
                on(dom.byId("previous"), "click", selectPrevious);
                on(dom.byId("next"), "click", selectNext);

                var bounds = new Extent({
                    xmin: 2526488.307204361,
                    ymin: 6968421.825135857,
                    xmax: 2574514.620465,
                    ymax: 6996793.93402322 ,
                    "spatialReference": {"wkid":102738}
                });
                var map = new Map("map",{extent: bounds});
                var urls = {
                     "urlBm": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/cached_services/basemap_parcels_bldg_add/MapServer"
                    ,"urlMs": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/public_works/PW_City_Construction_Projects/MapServer"
                    ,"urlFs": "http://gispub.cityofmesquite.com:6080/arcgis/rest/services/public_works/PW_City_Construction_Projects/FeatureServer/0"
                };

                var baseMap = new esri.layers.ArcGISTiledMapServiceLayer(urls.urlBm);
                var layer = new esri.layers.ArcGISDynamicMapServiceLayer(urls.urlMs);
                map.addLayer(baseMap);
                map.addLayer(layer);
                var infoTemplate = new InfoTemplate("</b>${PROJECT_NAME}<br>", "${PROJECT_SCOPE}");
                var featureLayerOptions = {
                    id: "Projects"
                    , mode: FeatureLayer.MODE_AUTO
                    , outFields: ["PROJECT_NAME","PROJECT_SCOPE"]
                    , infoTemplate: infoTemplate
                };
                var features = new FeatureLayer(
                                                urls.urlFs
                                               ,featureLayerOptions
                                             );

                map.addLayer(features);
                map.infoWindow.set("popupWindow",false);
                //window.map = map;

                    //set the popup's popupWindow property to false. This prevents the popup from displaying


                    initializeSidebar(map);

                function initializeSidebar(map){
                    var popup = map.infoWindow;

                    //when the selection changes update the side panel to display the popup info for the
                    //currently selected feature.
                    connect.connect(popup, "onSelectionChange", function(){
                        displayPopupContent(popup.getSelectedFeature());
                    });

                    //when the selection is cleared remove the popup content from the side panel.
                    connect.connect(popup, "onClearFeatures", function(){
                        //dom.byId replaces dojo.byId
                        dom.byId("featureCount").innerHTML = "Click to select feature(s)";
                        //registry.byId replaces dijit.byId
                        registry.byId("leftPane").set("content", "");
                        domUtils.hide(dom.byId("pager"));
                    });

                    //When features are associated with the  map's info window update the sidebar with the new content.
                    connect.connect(popup, "onSetFeatures", function(){
                        displayPopupContent(popup.getSelectedFeature());
                        dom.byId("featureCount").innerHTML = popup.features.length + " feature(s) selected";

                        //enable navigation if more than one feature is selected
                        popup.features.length > 1 ? domUtils.show(dom.byId("pager")) : domUtils.hide(dom.byId("pager"));
                    });
                }

                function displayPopupContent(feature){
                    if(feature){
                        var content = feature.getContent();
                        registry.byId("leftPane").set("content", content);
                    }
                }

                function selectPrevious(){
                    window.map.infoWindow.selectPrevious();
                }

                function selectNext(){
                    window.map.infoWindow.selectNext();
                }
            });
        });
    </script>
</head>

<body class="claro">
<div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer"
     data-dojo-props="design:'headline',gutters:false"
     style="width:100%; height:100%;">
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:false"
         region="left" style="width: 20%;height:100%;">
        <div id="leftPane" data-dojo-type="dijit/layout/ContentPane"
             data-dojo-props="region:'center'"></div>
        <div id="header" data-dojo-type="dijit/layout/ContentPane"
             data-dojo-props="region:'top'">
            <div id="featureCount" style="margin-bottom:5px;">Click to select feature(s)</div>
            <div id="pager" style="display:none;">
                <a href='javascript:void(0);' id ="previous" class='nav' style="text-decoration: none;">
                    < Prev
                </a>

                <a href='javascript:void(0);' id="next" class='nav'  style="text-decoration: none;">
                    Next >
                </a>
            </div>
        </div>
    </div>
    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"></div>
</div>
</body>

</html>
